name: Deploy a Producci√≥n

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de despliegue'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy-render:
    name: Deploy a Render
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    environment:
      name: production
      url: ${{ secrets.RENDER_APP_URL }}
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Notificar inicio de deploy
      run: |
        echo "üöÄ Iniciando deploy a producci√≥n..."
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
    
    - name: Deploy a Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
    
    - name: Esperar a que el deploy termine
      run: |
        echo "‚è≥ Esperando a que el deploy termine..."
        sleep 60
    
    - name: Verificar salud del servicio
      run: |
        echo "üîç Verificando salud del servicio..."
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RENDER_APP_URL }}/admin/)
        if [ $response -eq 200 ] || [ $response -eq 302 ]; then
          echo "‚úÖ Servicio funcionando correctamente"
        else
          echo "‚ùå Error: Servicio no responde correctamente (HTTP $response)"
          exit 1
        fi
    
    - name: Notificar √©xito
      if: success()
      run: |
        echo "‚úÖ Deploy completado exitosamente"
        echo "URL: ${{ secrets.RENDER_APP_URL }}"
    
    - name: Notificar fallo
      if: failure()
      run: |
        echo "‚ùå Deploy fall√≥"
        echo "Revisa los logs en Render"

  deploy-vps:
    name: Deploy a VPS (Opcional)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /var/www/parking-system
          git pull origin main
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          sudo systemctl restart gunicorn
          sudo systemctl restart nginx
    
    - name: Verificar deploy en VPS
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.VPS_URL }})
        if [ $response -eq 200 ] || [ $response -eq 302 ]; then
          echo "‚úÖ VPS funcionando correctamente"
        else
          echo "‚ùå Error en VPS (HTTP $response)"
          exit 1
        fi

  post-deploy:
    name: Tareas Post-Deploy
    runs-on: ubuntu-latest
    needs: [deploy-render]
    if: success()
    
    steps:
    - name: Crear release en GitHub
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Cambios en esta versi√≥n
          
          Deploy autom√°tico a producci√≥n completado.
          
          ### Verificaciones
          - ‚úÖ Tests pasados
          - ‚úÖ Seguridad verificada
          - ‚úÖ Deploy exitoso
          
          ### URLs
          - Producci√≥n: ${{ secrets.RENDER_APP_URL }}
        draft: false
        prerelease: false
    
    - name: Notificaci√≥n de √©xito
      run: |
        echo "üéâ Deploy completado y verificado"
        echo "Versi√≥n: ${{ github.ref }}"
